<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.srm.source.cux.rfx.infra.mapper.RcwlRfxLineSupplierMapper">
    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap id="BaseResultMap" type="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        <result column="rfx_line_supplier_id" property="rfxLineSupplierId" jdbcType="DECIMAL"/>
        <result column="rfx_header_id" property="rfxHeaderId" jdbcType="DECIMAL"/>
        <result column="tenant_id" property="tenantId" jdbcType="DECIMAL"/>
        <result column="off_line_flag" property="offLineFlag" jdbcType="DECIMAL"/>
        <result column="supplier_tenant_id" property="supplierTenantId" jdbcType="DECIMAL"/>
        <result column="supplier_company_id" property="supplierCompanyId" jdbcType="DECIMAL"/>
        <result column="supplier_company_name" property="supplierCompanyName" jdbcType="VARCHAR"/>
        <result column="supplier_contact_id" property="supplierContactId" jdbcType="DECIMAL"/>
        <result column="contact_name" property="contactName" jdbcType="VARCHAR"/>
        <result column="contact_mail" property="contactMail" jdbcType="VARCHAR"/>
        <result column="contact_mobilephone" property="contactMobilephone" jdbcType="VARCHAR"/>
        <result column="contact_telephone" property="contactTelephone" jdbcType="VARCHAR"/>
        <result column="feedback_status" property="feedbackStatus" jdbcType="VARCHAR"/>
        <result column="feedback_remark" property="feedbackRemark" jdbcType="VARCHAR"/>
        <result column="read_flag" property="readFlag" jdbcType="DECIMAL"/>
        <result column="abandon_remark" property="abandonRemark" jdbcType="VARCHAR"/>
        <result column="object_version_number" property="objectVersionNumber" jdbcType="DECIMAL"/>
        <result column="creation_date" property="creationDate" jdbcType="DATE"/>
        <result column="created_by" property="createdBy" jdbcType="DECIMAL"/>
        <result column="last_updated_by" property="lastUpdatedBy" jdbcType="DECIMAL"/>
        <result column="last_update_date" property="lastUpdateDate" jdbcType="DATE"/>
        <result column="company_num" property="companyNum" jdbcType="VARCHAR"/>
    </resultMap>
    <sql id="Base_Column_List">
        ls.rfx_line_supplier_id,
        ls.rfx_header_id,
        ls.tenant_id,
        ls.supplier_tenant_id,
        ls.supplier_company_id,
        ls.supplier_company_name,
        ls.supplier_contact_id,
        ls.contact_name,
        ls.contact_mail,
        ls.contact_mobilephone,
        ls.contact_telephone,
        ls.feedback_status,
        ls.feedback_remark,
        ls.read_flag,
        ls.abandon_remark,
        ls.object_version_number,
        ls.creation_date,
        ls.created_by,
        ls.price_coefficient,
        ls.last_updated_by,
        ls.append_remark,
        ls.pr_line_supplier_id,
        ls.off_line_flag,
        ls.last_update_date
    </sql>
    <select id="listRfxLineSupplier" resultType="org.srm.source.rfx.api.dto.RfxLineSupplierDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        <include refid="Base_Column_List"/>,
        hc.company_num AS supplier_company_num,
        hc.company_id AS company_id,
        slcs.stage_id,
        slcs.stage_code,
        hc2.source_key AS spfm_company_id,
        hc.source_key AS spfm_supplier_company_id,
        sp.partner_company_id,
        sp.partner_tenant_id,
        slcst.stage_description,
        CASE
        WHEN sm.monitor_id IS NULL
        THEN 0
        ELSE 1
        END is_monitor,
        CASE
        WHEN srs.risk_scan_id IS NULL
        THEN 0
        ELSE 1
        END is_show_scan
        FROM
        ssrc_rfx_line_supplier ls
        JOIN hpfm_company hc ON ls.supplier_company_id = hc.company_id
        JOIN ssrc_rfx_header srh ON ls.rfx_header_id = srh.rfx_header_id
        --         JOIN spfm_company_basic ca ON hc.source_key = ca.company_basic_id
        --         JOIN spfm_company_contacts cc ON ca.company_id = cc.company_id AND cc.default_flag = 1
        LEFT JOIN sslm_life_cycle slc ON hc.company_id = slc.supplier_company_id and slc.tenant_id = srh.tenant_id and
        slc.company_id = srh.company_id
        left join hpfm_company hc2 ON slc.tenant_id = hc2.tenant_id AND slc.company_id = hc2.company_id
        LEFT JOIN spfm_partner sp ON slc.tenant_id = sp.tenant_id and slc.company_id =sp.company_id and slc.supplier_tenant_id = sp.partner_tenant_id and slc.supplier_company_id = sp.partner_company_id
        LEFT JOIN sslm_supplier_basic ssb on sp.supplier_basic_id = ssb.supplier_basic_id
        LEFT JOIN sslm_life_cycle_config slcc ON slc.tenant_id = slcc.tenant_id AND slcc.latest_flag = 1
        LEFT JOIN sslm_life_cycle_stages slcs ON slc.stage_id = slcs.stage_id
        LEFT JOIN sslm_life_cycle_stages_tl slcst ON slcst.stage_id = slcs.stage_id AND slcst.lang = #{lang}
        LEFT JOIN sslm_monitor sm ON sm.tenant_id = ls.tenant_id AND sm.supplier_company_id = ls.supplier_company_id
        LEFT JOIN sslm_risk_scan srs ON srs.tenant_id = ls.tenant_id AND srs.scan_code = 'rfx_supplier' AND
        srs.enabled_flag = 1
        <where>
            <if test="rfxLineSupplierId != null">
                and ls.rfx_line_supplier_id = #{rfxLineSupplierId}
            </if>
            <if test="rfxHeaderId != null">
                and srh.rfx_header_id = #{rfxHeaderId}
            </if>
            <if test="tenantId != null">
                and srh.tenant_id = #{tenantId}
            </if>
            <if test="appendFlag != null">
                and ls.append_flag = #{appendFlag}
            </if>
        </where>
    </select>

    <select id="listRfxSupplierByHeaderId" resultMap="BaseResultMap">
        <bind name="userDetails" value="@io.choerodon.core.oauth.DetailsHelper@getUserDetails()"/>
        select
        hc.company_num,
        <include refid="Base_Column_List"></include>
        from
        ssrc_rfx_line_supplier ls left join hpfm_company hc on ls.supplier_company_id = hc.company_id
        where
        ls.rfx_header_id = #{headerId} and ls.tenant_id = #{userDetails.tenantId}
    </select>
    <select id="selectByCompanyId" resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        SELECT
            hc.tenant_id AS supplier_tenant_id,
            hc.company_id AS supplier_company_id,
            hc.company_name AS supplier_company_name,
            scc.company_contact_id AS supplier_contact_id,
            scc.name AS contact_name,
            scc.mail AS contact_mail,
            scc.mobilephone AS contact_mobilephone,
            scc.telephone AS contact_telephone
        FROM
            hpfm_company hc
                LEFT JOIN spfm_company_contacts scc ON hc.source_key = scc.company_id
        WHERE
            hc.company_id = #{supplierCompanyId}
          AND scc.default_flag = 1
    </select>

    <select id="selectByCompanyName" resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        SELECT
            hc.tenant_id AS supplier_tenant_id,
            hc.company_id AS supplier_company_id,
            hc.company_name AS supplier_company_name,
            scc.company_contact_id AS supplier_contact_id,
            scc.name AS contact_name,
            scc.mail AS contact_mail,
            scc.mobilephone AS contact_mobilephone,
            scc.telephone AS contact_telephone
        FROM
            hpfm_company hc
                JOIN spfm_partner sp ON hc.company_id = sp.partner_company_id
                LEFT JOIN spfm_company_contacts scc ON hc.source_key = scc.company_id
        WHERE
            hc.company_name = #{supplierCompanyName}
          and sp.tenant_id=#{tenantId}
          and sp.company_id=#{companyId}
          AND scc.default_flag = 1
    </select>

    <select id="listRfxBargainSuppliers" resultType="org.srm.source.rfx.api.dto.RfxLineSupplierDTO">
        SELECT
        ls.rfx_line_supplier_id,
        ls.rfx_header_id,
        ls.read_flag,
        ls.tenant_id,
        ls.supplier_tenant_id,
        ls.supplier_company_id,
        ls.supplier_company_name,
        ls.supplier_contact_id,
        ls.contact_name,
        ls.contact_mail,
        ls.price_coefficient,
        ls.contact_mobilephone,
        ls.contact_telephone,
        ls.feedback_status,
        srqh.pre_approve_status as prequal_line_status,
        CONCAT((CASE WHEN qh2.count2 is null THEN 0 ELSE qh2.count2 END ),
        CONCAT('/',CASE WHEN li.count1 is null THEN 0 ELSE li.count1 END )) AS quotation_number,
        CASE WHEN li.count1 is null THEN 0 ELSE li.count1 END AS total_quotation_number,
        li.count1 AS total_item_count,
        srqh.quotation_status,
        srqh.submit_attachment_flag,
        srqh.business_attachment_uuid,
        srqh.tech_attachment_uuid,
        ( SELECT
        round(sum(srql.valid_quotation_price * srql.valid_quotation_quantity * srqh.exchange_rate / srql.price_batch_quantity),2)
        FROM
        ssrc_rfx_quotation_line srql
        JOIN ssrc_rfx_quotation_header srqh ON srql.quotation_header_id = srqh.quotation_header_id
        AND srql.round_number = srqh.round_number
        join ssrc_rfx_header srh on srh.round_number =srqh.round_number and srh.rfx_header_id = srqh.rfx_header_id
        WHERE
        ls.supplier_company_id = srqh.supplier_company_id
        AND ls.rfx_header_id = srqh.rfx_header_id
        ) as supplier_total_amount,
        ( SELECT
        round(sum(srql.valid_bargain_price * srql.valid_bargain_quantity),2)
        FROM
        ssrc_rfx_quotation_line srql
        JOIN ssrc_rfx_quotation_header srqh ON srql.quotation_header_id = srqh.quotation_header_id
        AND srql.round_number = srqh.round_number
        join ssrc_rfx_header srh on srh.round_number =srqh.round_number and srh.rfx_header_id = srqh.rfx_header_id
        WHERE
        ls.supplier_company_id = srqh.supplier_company_id
        AND ls.rfx_header_id = srqh.rfx_header_id
        ) as bargain_total_amount,
        hc.company_num AS supplier_company_num
        FROM
        ssrc_rfx_line_supplier ls
        JOIN hpfm_company hc ON ls.supplier_company_id = hc.company_id
        LEFT JOIN ssrc_rfx_header srh on srh.rfx_header_id = ls.rfx_header_id
        LEFT JOIN ssrc_prequal_header sph on sph.rfx_header_id = #{rfxHeaderId}
        left join ssrc_rfx_quotation_header srqh on ls.rfx_header_id = srqh.rfx_header_id and srqh.supplier_company_id = hc.company_id and srqh.round_number = srh.round_number
        LEFT JOIN ( SELECT rfx_header_id, tenant_id, count( 1 ) AS count1 FROM ssrc_rfx_line_item GROUP BY
        rfx_header_id, tenant_id ) li ON li.rfx_header_id = ls.rfx_header_id AND li.tenant_id = ls.tenant_id
        LEFT JOIN (SELECT h.rfx_header_id,h.supplier_company_id,h.round_number,count( 1 ) AS count2 FROM
        ssrc_rfx_quotation_header h JOIN ssrc_rfx_quotation_line l ON h.quotation_header_id = l.quotation_header_id AND
        (l.quotation_line_status = 'SUBMITTED' OR l.quotation_line_status = 'BARGAINED') GROUP BY
        h.rfx_header_id,h.round_number,h.supplier_company_id) qh2 ON qh2.rfx_header_id = ls.rfx_header_id and
        qh2.supplier_company_id = ls.supplier_company_id and qh2.round_number = srh.round_number
        <where>
            <if test="rfxLineSupplierId != null">
                and ls.rfx_line_supplier_id = #{rfxLineSupplierId}
            </if>
            <if test="rfxHeaderId != null">
                and ls.rfx_header_id = #{rfxHeaderId}
            </if>
            <if test="tenantId != null">
                and ls.tenant_id = #{tenantId}
            </if>
        </where>
    </select>
    <select id="listRfxCheckSuppliers" resultType="org.srm.source.rfx.api.dto.RfxLineSupplierDTO">
        SELECT
        srh.round_number,
        ls.rfx_line_supplier_id,
        ls.rfx_header_id,
        ls.read_flag,
        ls.tenant_id,
        ls.off_line_flag,
        ls.append_flag,
        ls.append_remark,
        ls.supplier_tenant_id,
        ls.supplier_company_id,
        ls.supplier_company_name,
        ls.supplier_contact_id,
        ls.contact_name,
        ls.contact_mail,
        ls.contact_mobilephone,
        ls.contact_telephone,
        ls.feedback_status,
        ls.suggested_remark,
        ls.allotted_ratio,
        ls.price_coefficient,
        ls.object_version_number,
        li.rfx_line_item_id ,
        qh2.quotation_line_id,
        qh.pre_approve_status as prequal_line_status,
        CONCAT((CASE WHEN qh2.count2 is null THEN 0 ELSE qh2.count2 END ),
        CONCAT('/',CASE WHEN li.count1 is null THEN 0 ELSE li.count1 END )) AS quotation_number,
        CASE WHEN li.count1 is null THEN 0 ELSE li.count1 END AS total_quotation_number,
        CASE WHEN qh2.whole_suggest_count = qh2.count2 THEN 1 ELSE 0 END AS whole_suggest_flag,
        li.count1 AS total_item_count,
        CASE WHEN (SELECT  COUNT(1)  FROM ssrc_rfx_quotation_line nsrql WHERE nsrql.quotation_header_id = qh.quotation_header_id and nsrql.quotation_line_status in ('SUBMITTED','BARGAINED')) is null THEN 0
        ELSE (SELECT  COUNT(1)  FROM ssrc_rfx_quotation_line nsrql WHERE nsrql.quotation_header_id = qh.quotation_header_id and nsrql.quotation_line_status in ('SUBMITTED','BARGAINED')) END AS quotation_line_number,
        qh.quotation_status,
        qh.submit_attachment_flag,
        qh.business_attachment_uuid,
        qh.round_business_attachment_uuid,
        qh.bargain_business_attachment_uuid,
        qh.round_tech_attachment_uuid,
        qh.bargain_tech_attachment_uuid,
        qh.tech_attachment_uuid,
        qh.supplier_company_ip,
        qh.quotation_header_id,
        qh.attribute_varchar2,
        hc.company_num AS supplier_company_num,
        CASE
        WHEN sm.monitor_id IS NULL
        THEN 0
        ELSE 1
        END is_monitor,
        CASE
        WHEN srs.risk_scan_id IS NULL
        THEN 0
        ELSE 1
        END is_show_scan,
        summary.score,
        summary.business_score,
        summary.technology_score,
        ( SELECT
        round(sum(
        <if test='priceTypeCode != null and priceTypeCode == "TAX_INCLUDED_PRICE"'>
              srql.valid_quotation_price *
          </if>
        <if test='priceTypeCode != null and priceTypeCode == "NET_PRICE"'>
            srql.valid_net_price *
        </if>
             srql.valid_quotation_quantity  ),2)
        FROM
        ssrc_rfx_quotation_line srql
        JOIN ssrc_rfx_quotation_header srqh ON srql.quotation_header_id = srqh.quotation_header_id
        AND srql.round_number = srqh.round_number
        WHERE
        ls.supplier_company_id = srqh.supplier_company_id
        AND ls.rfx_header_id = srqh.rfx_header_id
        AND srqh.round_number = srh.round_number
        ) as supplier_total_amount,
        summary.candidate_flag,
        summary.candidate_suggestion,
        case summary.invalid_flag when 1 then 1 else 0 end  as invalid_flag,
        rs.summary_review_result,
        srh.quotation_type,
        CASE WHEN qh.on_line_flag IS NULL THEN 1 ELSE qh.on_line_flag END AS on_line_flag
        FROM
        ssrc_rfx_line_supplier ls
        LEFT JOIN hpfm_company hc ON ls.supplier_company_id = hc.company_id
        LEFT JOIN ssrc_rfx_header srh on srh.rfx_header_id = ls.rfx_header_id
        LEFT JOIN ssrc_prequal_header sph on sph.rfx_header_id = #{rfxHeaderId} and sph.tenant_id = ls.tenant_id and sph.prequal_category = 'RFX'
        LEFT JOIN ( SELECT quotation_header_id,rfx_header_id,supplier_company_ip,submit_attachment_flag,
        business_attachment_uuid,tech_attachment_uuid,round_business_attachment_uuid,bargain_business_attachment_uuid,round_tech_attachment_uuid,bargain_tech_attachment_uuid,supplier_company_id, supplier_company_name,
        round_number,tenant_id, quotation_status, on_line_flag,pre_approve_status,attribute_varchar2 FROM ssrc_rfx_quotation_header ) qh ON qh.rfx_header_id =
        ls.rfx_header_id AND((qh.supplier_company_id = ls.supplier_company_id) OR (qh.supplier_company_id IS NULL AND
        qh.supplier_company_name = ls.supplier_company_name)) AND srh.round_number = qh.round_number
        LEFT JOIN ( SELECT rfx_header_id,max(rfx_line_item_id) as rfx_line_item_id, tenant_id, count( 1 ) AS count1 FROM ssrc_rfx_line_item GROUP BY
        rfx_header_id, tenant_id) li ON li.rfx_header_id = ls.rfx_header_id AND li.tenant_id = ls.tenant_id
        LEFT JOIN (SELECT h.rfx_header_id,h.rfx_line_supplier_id,h.round_number,count( 1 ) AS
        count2,sum(suggested_flag) AS whole_suggest_count , max(l.quotation_line_id) as quotation_line_id FROM ssrc_rfx_quotation_header h JOIN ssrc_rfx_quotation_line
        l ON h.quotation_header_id = l.quotation_header_id AND (l.quotation_line_status = 'SUBMITTED' OR
        l.quotation_line_status = 'BARGAINED' OR l.quotation_line_status = 'ROUND_QUOTATION') GROUP BY h.rfx_header_id,h.round_number,h.rfx_line_supplier_id) qh2 ON
        qh2.rfx_header_id = ls.rfx_header_id and qh2.rfx_line_supplier_id = ls.rfx_line_supplier_id and
        qh2.round_number = srh.round_number
        LEFT JOIN sslm_monitor sm ON sm.tenant_id = ls.tenant_id AND sm.supplier_company_id = ls.supplier_company_id
        LEFT JOIN sslm_risk_scan srs ON srs.tenant_id = ls.tenant_id AND srs.scan_code = 'rfx_supplier' AND
        srs.enabled_flag = 1
        LEFT JOIN ssrc_evaluate_summary summary on (summary.quotation_header_id = qh.quotation_header_id
        and summary.tenant_id = qh.tenant_id and summary.source_header_id = qh.rfx_header_id
        and summary.source_from = 'RFX' and summary.round_number = qh.round_number
        and (summary.evaluate_summary_type = 'SCORE' or summary.evaluate_summary_type is null )
        )
        LEFT JOIN ssrc_evaluate_summary rs on (rs.quotation_header_id = qh.quotation_header_id
        and rs.tenant_id = qh.tenant_id and rs.source_header_id = qh.rfx_header_id
        and rs.source_from = 'RFX' and rs.round_number = qh.round_number
        and (rs.evaluate_summary_type = 'REVIEW_SCORE')
        )
        <where>
            <if test="rfxLineSupplierId != null">
                and ls.rfx_line_supplier_id = #{rfxLineSupplierId}
            </if>
            <if test="rfxHeaderId != null">
                and ls.rfx_header_id = #{rfxHeaderId}
            </if>
            <if test="tenantId != null">
                and ls.tenant_id = #{tenantId}
            </if>
            <if test="invalidFlag != null">
                and (summary.invalid_flag = #{invalidFlag} OR summary.invalid_flag IS NULL)
            </if>
            <if test="candidateFlag != null">
                and (summary.candidate_flag = #{candidateFlag} OR summary.candidate_flag IS NULL)
            </if>
            <if test="expertScoreType != 'ONLINE'">
                <if test='priceTypeCode != null'>
                    order by supplier_total_amount
                </if>
                <if test='auctionDirection != null and auctionDirection == "FORWARD"'>
                    DESC
                </if>
                <if test='auctionDirection != null and auctionDirection == "REVERSE"'>
                    ASC
                </if>
            </if>
            <if test='expertScoreType != null and expertScoreType == "ONLINE"'>
                    order by summary.score DESC
            </if>
        </where>
    </select>

    <select id="selectSupplierByUniqueCondition" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"></include>
        from
        ssrc_rfx_line_supplier ls
        where
        ls.tenant_id = #{tenantId}
        and ls.rfx_header_id = #{rfxHeaderId}
        and ls.supplier_company_id = #{companyId}
    </select>
    <delete id="deleteSupplierByHeaderId" parameterType="java.lang.Long">
        DELETE FROM ssrc_rfx_line_supplier where rfx_header_id = #{rfxHeaderId}
    </delete>
    <select id="selectSupplierInfoByUserId" parameterType="java.lang.Long"
            resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        SELECT
            ui.company_name as supplier_company_name
        FROM
            hiam_user_info ui ON  ui.user_id = #{quotedBy}
    </select>

    <select id="selectByCompanyNum" parameterType="java.lang.String" resultType="java.lang.Long">
        select hc.company_id from hpfm_company hc where company_num = #{companyNum}
    </select>

    <select id="selectByCompanyNumSingle" parameterType="java.lang.String"
            resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        select
        hc.supplier_company_id,
        hc.company_name as supplier_company_name,
        cc.supplier_contact_id,
        cc.name AS contact_name,
        cc.mail AS contact_mail,
        cc.mobilephone AS contact_mobilephone
        FROM
            spfm_partner sp
            LEFT JOIN sslm_supplier_basic hc ON hc.supplier_basic_id = sp.supplier_basic_id
            LEFT JOIN sslm_supplier_basic_tl ssbt ON ssbt.supplier_basic_id = hc.supplier_basic_id AND ssbt.lang = #{lang}
            LEFT JOIN sslm_supplier_contact cc on cc.supplier_contact_id =
                                                (SELECT ssc.supplier_contact_id
                                                FROM sslm_supplier_contact ssc
                                                WHERE hc.supplier_basic_id = ssc.supplier_basic_id
                                                AND ssc.default_flag = '1'
                                                <if test="_databaseId == 'mysql'">
                                                    LIMIT 1
                                                </if>
                                                <if test="_databaseId == 'oracle'">
                                                    rownum=1
                                                </if>
                                                )
        where
          sp.company_id = #{rfxHeader.companyId}
          and sp.tenant_id = #{rfxHeader.tenantId}
          and hc.company_num = #{companyNum}
          and sp.enabled_flag = '1'
    </select>

    <select id="selectByCompanyNameSingle" parameterType="java.lang.String"
            resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        select
        hc.supplier_company_id,
        hc.company_name as supplier_company_name,
        cc.supplier_contact_id,
        cc.name AS contact_name,
        cc.mail AS contact_mail,
        cc.mobilephone AS contact_mobilephone
        FROM
        spfm_partner sp
        LEFT JOIN sslm_supplier_basic hc ON hc.supplier_basic_id = sp.supplier_basic_id
        LEFT JOIN sslm_supplier_basic_tl ssbt ON ssbt.supplier_basic_id = hc.supplier_basic_id AND ssbt.lang = #{lang}
        LEFT JOIN sslm_supplier_contact cc on cc.supplier_contact_id =
        (SELECT ssc.supplier_contact_id
        FROM sslm_supplier_contact ssc
        WHERE hc.supplier_basic_id = ssc.supplier_basic_id
        AND ssc.default_flag = '1'
        <if test="_databaseId == 'mysql'">
            LIMIT 1
        </if>
        <if test="_databaseId == 'oracle'">
            rownum=1
        </if>
        )
        where
        sp.company_id = #{rfxHeader.companyId}
        and sp.tenant_id = #{rfxHeader.tenantId}
        and hc.company_name = #{companyName}
        and sp.enabled_flag = '1'
    </select>

    <select id="querySuppliers" resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        SELECT <include refid="Base_Column_List"/>
        from
        ssrc_rfx_line_supplier ls
        WHERE
        ls.tenant_id =  #{lineSupplier.tenantId}
        and ls.rfx_header_id =#{lineSupplier.rfxHeaderId}
        and
        exists(
        select 1 from sslm_supply_ability ssa
        join sslm_supply_ability_line ssal on ssal.supply_ability_id = ssa.supply_ability_id and ssal.tenant_id = ssa.tenant_id
        where ssa.supplier_company_id  = ls.supplier_company_id
        and ssal.item_category_id =  #{itemCategoryId}
        and ssa.supplier_tenant_id = ls.supplier_tenant_id
        and ssa.tenant_id = ls.tenant_id
        )
    </select>
    <select id="selectByItemCategoryIdBySupplierId" resultType="java.lang.Long">
        SELECT
            ssal.item_category_id
        FROM
            sslm_supply_ability_line ssal
                join sslm_supply_ability ssa on ssal.supply_ability_id = ssa.supply_ability_id and ssa.tenant_id = ssal.tenant_id
        WHERE
            ssal.tenant_id = #{tenantId}
          AND ssa.supplier_tenant_id = #{supplierTenantId}
          and ssa.supplier_company_id = #{supplierCompanyId}

    </select>
    <select id="selectSuggestedSupplierList" resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        select srqh.supplier_company_id,srqh.supplier_company_name,srqh.supplier_tenant_id
        from
            ssrc_rfx_quotation_line srql
                join ssrc_rfx_quotation_header srqh on srqh.quotation_header_id = srql.quotation_header_id
                JOIN ssrc_rfx_header srh ON srh.rfx_header_id = srqh.rfx_header_id and srh.round_number = srqh.round_number
        where srql.suggested_flag = 1
          and srqh.rfx_header_id = #{rfxHeaderId}
          and srqh.tenant_id = #{tenantId}
        GROUP BY
            srqh.supplier_company_id,
            srqh.supplier_company_name,
            srqh.supplier_tenant_id
    </select>
    <select id="queryLossRfxSuppliers" resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        SELECT
            srqh.supplier_company_id,
            srqh.supplier_company_id,
            srqh.supplier_tenant_id,
            srqh.supplier_company_name
        FROM
            ssrc_rfx_quotation_header srqh
                JOIN ssrc_rfx_header srh ON srh.rfx_header_id = srqh.rfx_header_id
                AND srh.round_number = srqh.round_number
        WHERE
            srh.rfx_header_id = #{rfxHeaderId}
          AND srh.tenant_id = #{tenantId}
          AND NOT EXISTS ( SELECT 1 FROM ssrc_rfx_quotation_line srql WHERE srqh.quotation_header_id = srql.quotation_header_id AND srql.suggested_flag = 1 )
    </select>
    <select id="selectByCompanyNumAndName" resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        select
        hc.company_id as supplier_company_id,
        hc.company_name as supplier_company_name,
        scc.company_contact_id AS supplier_contact_id,
        scc.name AS contact_name,
        scc.mail AS contact_mail,
        scc.mobilephone AS contact_mobilephone,
        scc.telephone AS contact_telephone
        from hpfm_company hc
        LEFT JOIN spfm_company_contacts scc ON hc.source_key = scc.company_id
        where
        hc.company_num = #{companyNum} and scc.default_flag = '1'
        <if test="companyName != null and companyName != ''">
            and hc.company_name = #{companyName}
        </if>
    </select>
    <select id="selectCompanyIdWithPartner" resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        SELECT
            hc.supplier_tenant_id,
            hc.supplier_company_id,
            hc.company_name AS supplier_company_name,
            scc.supplier_contact_id AS supplier_contact_id,
            scc.name AS contact_name,
            scc.mail AS contact_mail,
            scc.mobilephone AS contact_mobilephone,
            scc.telephone AS contact_telephone
        FROM
            spfm_partner sp
                JOIN sslm_supplier_basic hc ON sp.supplier_basic_id = hc.supplier_basic_id
                LEFT JOIN sslm_supplier_contact scc ON scc.supplier_basic_id = hc.supplier_basic_id AND scc.default_flag = 1
        WHERE
            sp.company_id = #{companyId}
          AND sp.partner_company_id = #{supplierCompanyId}
        <if test="_databaseId == 'mysql'">
            LIMIT 1
        </if>
        <if test="_databaseId == 'oracle'">
            rownum=1
        </if>
    </select>

    <delete id="deleteNotAssignRfxItemSupplierLine">
        DELETE
        <if test="_databaseId == 'mysql'">
            srls
        </if>
        FROM
        ssrc_rfx_line_supplier srls
        WHERE
        srls.tenant_id = #{tenantId}
        AND srls.rfx_header_id = #{rfxHeaderId}
        AND NOT EXISTS ( SELECT 1 FROM ssrc_rfx_item_sup_assign srisa
        WHERE srisa.tenant_id = #{tenantId}
        AND srisa.rfx_header_id = #{rfxHeaderId}
        AND srisa.rfx_line_supplier_id = srls.rfx_line_supplier_id )
    </delete>

    <select id="selectLineSupplierBySupplierCompany" resultType="org.srm.source.rfx.domain.entity.RfxLineSupplier">
        SELECT
            srls.rfx_line_supplier_id
        FROM
        ssrc_rfx_line_supplier srls
        LEFT JOIN hpfm_company hc ON srls.supplier_company_id = hc.company_id
        WHERE
        srls.rfx_header_id = #{rfxHeaderId}
        <if test="supplierCompanyName != null and supplierCompanyName != ''">
            AND (srls.supplier_company_name = #{supplierCompanyName} OR hc.company_name = #{supplierCompanyName})
        </if>
        <if test="companyNum != null and companyNum != ''">
            AND hc.company_num = #{companyNum}
        </if>
    </select>
</mapper>
